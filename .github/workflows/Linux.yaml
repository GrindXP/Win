name: Linux NoMachine RDP

on:
  workflow_dispatch:

jobs:
  linux-nomachine-setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Show disks
        run: |
          df -h
          df -h /mnt

      - name: Prepare /mnt workspace
        run: |
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace
          echo "WORKSPACE=/mnt/workspace" >> $GITHUB_ENV

      - name: Install desktop environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies \
            dbus-x11 x11-xserver-utils \
            xvfb xauth

      - name: Install NoMachine
        run: |
          cd /tmp
          VER=8.11.3_4
          wget https://download.nomachine.com/download/${VER%.*}/Linux/nomachine_${VER}_amd64.deb
          file nomachine_${VER}_amd64.deb
          sudo dpkg -i nomachine_${VER}_amd64.deb || sudo apt-get install -f -y
          echo "âœ… NoMachine installed"

      - name: Configure virtual display
        run: |
          export DISPLAY=:0
          Xvfb :0 -screen 0 1920x1080x24 &
          sleep 5
          DISPLAY=:0 nohup startxfce4 &
          sleep 10
          sudo /usr/NX/bin/nxserver --restart

      - name: Create NoMachine user
        run: |
          PASSWORD=$(openssl rand -base64 16)
          sudo useradd -m -s /bin/bash nomachine
          echo "nomachine:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo nomachine
          echo "NOMACHINE_USER=nomachine" >> $GITHUB_ENV
          echo "NOMACHINE_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-linux-nomachine-${{ github.run_id }} \
            --accept-routes
          sleep 5
          TAILSCALE_IP=$(tailscale ip -4)
          if [ -z "$TAILSCALE_IP" ]; then
            echo "Failed to get Tailscale IP"
            exit 1
          fi
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      - name: Display connection info
        run: |
          echo "IP: $TAILSCALE_IP"
          echo "User: $NOMACHINE_USER"
          echo "Pass: $NOMACHINE_PASS"
          echo "Workspace: $WORKSPACE"
          df -h /mnt

      - name: Keep session alive
        run: |
          while true; do
            sleep 300
          done
