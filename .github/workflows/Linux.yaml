name: Linux NoMachine RDP

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  linux-nomachine-setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Show disks
        run: |
          echo "=== Disk layout ==="
          df -h
          echo "=== /mnt details ==="
          df -h /mnt

      - name: Prepare /mnt workspace
        run: |
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace
          echo "WORKSPACE=/mnt/workspace" >> $GITHUB_ENV
          echo "âœ… /mnt/workspace ready"

      - name: Install desktop environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies \
            dbus-x11 x11-xserver-utils \
            xvfb xauth
          echo "âœ… XFCE Desktop installed"

      - name: Install NoMachine
        run: |
          cd /tmp
          # Use tar.gz to avoid .deb redirect issues
          wget https://download.nomachine.com/download/8.14/Linux/nomachine_8.14.2_1_amd64.tar.gz
          sudo tar xvzf nomachine_8.14.2_1_amd64.tar.gz -C /usr
          sudo /usr/NX/nxserver --install
          echo "âœ… NoMachine installed"

      - name: Configure virtual display (headless)
        run: |
          export DISPLAY=:0
          Xvfb :0 -screen 0 1920x1080x24 &
          sleep 5
          DISPLAY=:0 nohup startxfce4 &
          sleep 10
          sudo /usr/NX/bin/nxserver --restart
          echo "âœ… Virtual display at 1920x1080"

      - name: Create NoMachine user
        run: |
          PASSWORD=$(openssl rand -base64 16)
          sudo useradd -m -s /bin/bash nomachine
          echo "nomachine:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo nomachine

          echo "NOMACHINE_USER=nomachine" >> $GITHUB_ENV
          echo "NOMACHINE_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "âœ… User 'nomachine' created"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          echo "âœ… Tailscale installed"

      - name: Connect to Tailscale
        run: |
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-linux-nomachine-${{ github.run_id }} \
            --accept-routes

          sleep 5
          TAILSCALE_IP=$(tailscale ip -4)
          if [ -z "$TAILSCALE_IP" ]; then
            echo "âŒ Failed to get Tailscale IP"
            exit 1
          fi
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale connected: $TAILSCALE_IP"

      - name: Display connection info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ–¥ï¸  NoMachine Linux over Tailscale       â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  IP:        $TAILSCALE_IP                 â•‘"
          echo "â•‘  Port:      4000 (NX)                     â•‘"
          echo "â•‘  User:      $NOMACHINE_USER               â•‘"
          echo "â•‘  Password:  $NOMACHINE_PASS               â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Workspace: $WORKSPACE                    â•‘"
          echo "â•‘  /mnt free: $(df -h /mnt | tail -1 | awk '{print $4}')           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo
          echo "Use NoMachine client â†’ connect to $TAILSCALE_IP"

      - name: Keep session alive
        run: |
          echo "=== SESSION ACTIVE ==="
          while true; do
            if ! pgrep -x "nxserver.bin" >/dev/null; then
              echo "[$(date '+%H:%M:%S')] Restarting NoMachine..."
              sudo /usr/NX/bin/nxserver --restart
            fi
            if ! pgrep -x "Xvfb" >/dev/null; then
              echo "[$(date '+%H:%M:%S')] Restarting Xvfb..."
              export DISPLAY=:0
              Xvfb :0 -screen 0 1920x1080x24 &
              sleep 5
              DISPLAY=:0 nohup startxfce4 &
            fi
            if ! tailscale status | grep -qi "logged in"; then
              echo "[$(date '+%H:%M:%S')] Reconnecting Tailscale..."
              sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
            fi
            echo "[$(date '+%H:%M:%S')] OK | /mnt free: $(df -h /mnt | tail -1 | awk '{print $4}')"
            sleep 300
          done
