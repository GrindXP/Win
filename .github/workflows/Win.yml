name: Windows RDP + Google Drive (6 Hours)

on:
  workflow_dispatch:

jobs:
  rdp-drive:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Install WinFsp
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/winfsp/winfsp/releases/download/v2.0/winfsp-2.0.23075.msi" -OutFile "$env:TEMP\winfsp.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\winfsp.msi`" /quiet /norestart" -Wait
        Remove-Item "$env:TEMP\winfsp.msi" -Force

    - name: Install rclone
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-v1.69.3-windows-amd64.zip" -OutFile "$env:TEMP\rclone.zip"
        Expand-Archive "$env:TEMP\rclone.zip" "$env:TEMP\rclone" -Force
        Copy-Item "$env:TEMP\rclone\rclone-v1.69.3-windows-amd64\rclone.exe" "C:\Windows\System32\" -Force
        Remove-Item "$env:TEMP\rclone*" -Recurse -Force

    - name: Setup Google Drive
      shell: powershell
      env:
        SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
      run: |
        $configDir = "${env:USERPROFILE}\.config\rclone"
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null
        
        # Clean & write JSON
        $cleanJson = $env:SA_JSON -replace '\uFEFF','' -replace '[^\x20-\x7E\n]',''
        $jsonBytes = [Text.Encoding]::UTF8.GetBytes($cleanJson)
        [IO.File]::WriteAllBytes("${env:USERPROFILE}\sa.json", $jsonBytes)
        
        # Test JSON
        try {
          $test = Get-Content "${env:USERPROFILE}\sa.json" -Raw -Encoding UTF8 | ConvertFrom-Json
          Write-Host "âœ… SA: $($test.client_email)"
        } catch {
          Write-Error "JSON invalid: $_"
          exit 1
        }
        
        # rclone.conf (SIMPLE)
        @"
[gdrive]
type = drive
scope = drive
service_account_file = ${env:USERPROFILE}\sa.json
"@ | Out-File "${configDir}\rclone.conf" -Encoding ascii

    - name: Test Drive
      shell: powershell
      run: |
        rclone --config "${env:USERPROFILE}\.config\rclone\rclone.conf" ls gdrive: --max-depth 1
        Write-Host "âœ… Drive OK"

    - name: Mount G:
      shell: powershell
      run: |
        Stop-Process rclone -Force -ErrorAction SilentlyContinue
        Start-Sleep 2
        Start-Process rclone -ArgumentList "mount gdrive: G: --config `"${env:USERPROFILE}\.config\rclone\rclone.conf`" --vfs-cache-mode full --vfs-cache-max-size 8G --daemon" -WindowStyle Hidden
        
        for ($i=0; $i -lt 30; $i++) {
          if (Test-Path G:\) {
            Write-Host "âœ… G:\ mounted"
            dir G:\ | ft Name
            exit 0
          }
          Start-Sleep 3
        }
        throw "Mount failed"

    - name: Enable RDP
      shell: pwsh
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        Restart-Service TermService -Force

    - name: Create User
      shell: pwsh
      run: |
        $pass = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | % {[char]$_})
        New-LocalUser RDPUser ($pass | ConvertTo-SecureString -AsPlainText -Force) -AccountNeverExpires
        Add-LocalGroupMember Administrators RDPUser
        echo "PASS=$pass" >> $env:GITHUB_ENV

    - name: Tailscale
      shell: pwsh
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale_1.82.0_amd64.msi" -OutFile "$env:TEMP\ts.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\ts.msi`" /quiet" -Wait
        Remove-Item "$env:TEMP\ts.msi"
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey $env:TSKEY --hostname gh-rdp-${{ github.run_id }}
        $ip = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip --4)[0]
        echo "IP=$ip" >> $env:GITHUB_ENV

    - name: INFO
      shell: pwsh
      run: |
        Write-Host "`nðŸŽ‰ CONNECT: $($env:IP):3389" -ForegroundColor Green
        Write-Host "User: RDPUser" -ForegroundColor Cyan
        Write-Host "Pass: $($env:PASS)" -ForegroundColor Cyan
        Write-Host "Drive: G:\" -ForegroundColor Yellow

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          if (-not (Test-Path G:\")) {
            Stop-Process rclone -Force -EA 0
            rclone mount gdrive: G: --vfs-cache-mode full --daemon
          }
          Write-Host "$(Get-Date -f HH:mm) âœ… $($env:IP):3389"
          Start-Sleep 300
        }
