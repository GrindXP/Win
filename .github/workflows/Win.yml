name: Windows RDP + Google Drive (6 Hours)

on:
  workflow_dispatch:

jobs:
  rdp-drive:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Install WinFsp
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://github.com/winfsp/winfsp/releases/download/v2.1/winfsp-2.1.25156.msi" -OutFile "$env:TEMP\winfsp.msi"
        Start-Process msiexec.exe -ArgumentList '/i', "$env:TEMP\winfsp.msi", '/quiet', '/norestart' -Wait
        Remove-Item "$env:TEMP\winfsp.msi" -Force

    - name: Install rclone
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://downloads.rclone.org/v1.72.1/rclone-v1.72.1-windows-amd64.zip" -OutFile "$env:TEMP\rclone.zip"
        Expand-Archive "$env:TEMP\rclone.zip" -DestinationPath "$env:TEMP\rclone" -Force
        $rcloneFolder = Get-ChildItem "$env:TEMP\rclone" -Directory | Select-Object -First 1
        Copy-Item "$rcloneFolder.FullName\rclone.exe" "C:\Windows\System32\" -Force
        Remove-Item "$env:TEMP\rclone" -Recurse -Force

    - name: Setup Google Drive
      shell: powershell
      env:
        SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
      run: |
        $configDir = "$env:USERPROFILE\.config\rclone"
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null
        
        $cleanJson = $env:SA_JSON -replace '\uFEFF','' -replace '[^\x20-\x7E\n\r\t]',''
        $jsonPath = "$env:USERPROFILE\sa.json"
        [IO.File]::WriteAllText($jsonPath, $cleanJson, [Text.Encoding]::UTF8)
        
        try {
          $test = Get-Content $jsonPath -Raw | ConvertFrom-Json
          Write-Host "âœ… SA: $($test.client_email)"
        } catch {
          Write-Error "Invalid JSON: $_"
          exit 1
        }
        
        $confContent = @"
        [gdrive]
        type = drive
        scope = drive
        service_account_file = $jsonPath
        "@
        $confContent | Out-File "$configDir\rclone.conf" -Encoding ascii

    - name: Test Drive
      shell: powershell
      run: |
        rclone ls gdrive: --max-depth 1
        Write-Host "âœ… Drive connection OK"

    - name: Mount G
      shell: powershell
      run: |
        Stop-Process -Name rclone -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        
        $configPath = "$env:USERPROFILE\.config\rclone\rclone.conf"
        Start-Process rclone -ArgumentList "mount gdrive: G: --config `"$configPath`" --vfs-cache-mode full --vfs-cache-max-size 8G --daemon" -WindowStyle Hidden
        
        for ($i = 0; $i -lt 40; $i++) {
          if (Test-Path 'G:\') {
            Write-Host "âœ… G:\ mounted successfully"
            Get-ChildItem 'G:\' | Format-Table Name
            break
          }
          Start-Sleep -Seconds 3
        }
        if (-not (Test-Path 'G:\')) {
          Write-Host "âš ï¸ Mount may have failed or is delayed - continuing anyway"
        }

    - name: Enable RDP
      shell: pwsh
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Get-NetFirewallRule -DisplayGroup "Remote Desktop" | Set-NetFirewallRule -Enabled True
        Restart-Service TermService -Force

    - name: Create User
      shell: pwsh
      run: |
        $pass = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 16 | ForEach-Object {[char]$_})
        $securePass = ConvertTo-SecureString $pass -AsPlainText -Force
        New-LocalUser -Name RDPUser -Password $securePass -AccountNeverExpires -PasswordNeverExpires
        Add-LocalGroupMember -Group Administrators -Member RDPUser
        echo "PASS=$pass" >> $env:GITHUB_ENV

    - name: Install Tailscale
      shell: pwsh
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\ts.msi"
        Start-Process msiexec.exe -ArgumentList '/i', "$env:TEMP\ts.msi", '/quiet' -Wait
        Remove-Item "$env:TEMP\ts.msi" -Force
        
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TSKEY --hostname="gh-rdp-${{ github.run_id }}" --accept-risk=all
        $ip = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip --4)[0]
        echo "IP=$ip" >> $env:GITHUB_ENV

    - name: INFO
      shell: pwsh
      run: |
        Write-Host "`nðŸŽ‰ CONNECT VIA TAILSCALE:" -ForegroundColor Green
        Write-Host "$($env:IP):3389" -ForegroundColor Green
        Write-Host "Username: RDPUser" -ForegroundColor Cyan
        Write-Host "Password: $($env:PASS)" -ForegroundColor Cyan
        Write-Host "Google Drive mounted at: G:\" -ForegroundColor Yellow

    - name: Keep Alive
      shell: pwsh
      run: |
        while ($true) {
          if (-not (Test-Path 'G:\')) {
            Write-Host "Drive disappeared - attempting remount"
            Stop-Process -Name rclone -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
            $configPath = "$env:USERPROFILE\.config\rclone\rclone.conf"
            Start-Process rclone -ArgumentList "mount gdrive: G: --config `"$configPath`" --vfs-cache-mode full --vfs-cache-max-size 8G --daemon" -WindowStyle Hidden
          }
          
          Write-Host "$(Get-Date -Format HH:mm) âœ… Alive - Tailscale IP: $($env:IP):3389"
          Start-Sleep -Seconds 300
        }
