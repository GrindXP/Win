name: Windows RDP + Google Drive (6 Hours)

on:
  workflow_dispatch:

jobs:
  rdp-drive:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install WinFsp (Drive FUSE)
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/winfsp/winfsp/releases/download/v2.0/winfsp-2.0.23075.msi" -OutFile "$env:TEMP\winfsp.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "`"$env:TEMP\winfsp.msi`"", "/quiet", "/norestart" -Wait
          Remove-Item "$env:TEMP\winfsp.msi" -Force

      - name: Install rclone
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile "$env:TEMP\rclone.zip"
          Expand-Archive "$env:TEMP\rclone.zip" -DestinationPath "$env:TEMP\rclone" -Force
          $extractedDir = Get-ChildItem -Path "$env:TEMP\rclone" -Directory | Select-Object -First 1
          Move-Item "$($extractedDir.FullName)\rclone.exe" "C:\Windows\System32\rclone.exe" -Force
          Remove-Item "$env:TEMP\rclone.zip", "$env:TEMP\rclone" -Recurse -Force

      - name: Setup Google Drive âœ… FIXED JSON
        shell: powershell
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
        run: |
          # Fix encoding issue
          $configDir = "${env:USERPROFILE}\.config\rclone"
          New-Item -ItemType Directory -Path $configDir -Force | Out-Null
          
          # Write JSON properly (UTF8 bytes)
          $jsonBytes = [System.Text.Encoding]::UTF8.GetBytes($env:GDRIVE_SA_JSON)
          [System.IO.File]::WriteAllBytes("${env:USERPROFILE}\gdrive-sa.json", $jsonBytes)
          
          # Verify JSON
          $jsonTest = Get-Content "${env:USERPROFILE}\gdrive-sa.json" -Raw -Encoding UTF8 | ConvertFrom-Json
          Write-Host "âœ… JSON OK: $($jsonTest.client_email)"
          
          # rclone.conf
          @"
[gdrive]
type = drive
scope = drive
service_account_file = ${env:USERPROFILE}\gdrive-sa.json
"@ | Out-File "$configDir\rclone.conf" -Encoding ascii

      - name: Test Drive Connection
        shell: powershell
        run: |
          rclone --config "${env:USERPROFILE}\.config\rclone\rclone.conf" ls gdrive: --max-depth 1
          rclone --config "${env:USERPROFILE}\.config\rclone\rclone.conf" about gdrive:
          Write-Host "âœ… Drive connection OK"

      - name: Mount G: Drive
        shell: powershell
        run: |
          Start-Process -FilePath "rclone" -ArgumentList @(
            "mount", "gdrive:", "G:",
            "--config", "${env:USERPROFILE}\.config\rclone\rclone.conf",
            "--vfs-cache-mode", "full",
            "--vfs-cache-max-size", "10G",
            "--dir-cache-time", "5m",
            "--daemon"
          ) -WindowStyle Hidden

          $retries = 0
          while ($retries -lt 30) {
            if (Test-Path "G:\") {
              dir G:\ | Select -First 5
              Write-Host "âœ… G:\ mounted! (Your Drive)"
              break
            }
            Start-Sleep -Seconds 3
            $retries++
          }
          if (-not (Test-Path "G:\")) { throw "Mount failed" }

      - name: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      - name: Create RDP User
        shell: pwsh
        run: |
          $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 16 | % {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install & Connect Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "`"$env:TEMP\tailscale.msi`"", "/quiet" -Wait
          Remove-Item "$env:TEMP\tailscale.msi"
          
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$TAILSCALE_AUTH_KEY --hostname=gh-rdp-${{ github.run_id }}
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip --4 | Select -First 1
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: ğŸ‰ Connection Info
        shell: pwsh
        run: |
          Write-Host "`nğŸš€ RDP + 100GB DRIVE READY!" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host "ğŸŒ IP: $($env:TAILSCALE_IP):3389" -ForegroundColor Cyan
          Write-Host "ğŸ‘¤ User: RDP" -ForegroundColor Cyan
          Write-Host "ğŸ”‘ Pass: $($env:RDP_PASSWORD)" -ForegroundColor Cyan
          Write-Host "â˜ï¸  Drive: G:\" -ForegroundColor Yellow
          Write-Host "â° 6 Hours" -ForegroundColor Magenta
          Write-Host "`nğŸ’¡ In RDP: 'dir G:\' sees your Drive!" -ForegroundColor White

      - name: Keep Alive (6h)
        shell: pwsh
        timeout-minutes: 350
        run: |
          $end = (Get-Date).AddHours(5.8)
          while ((Get-Date) -lt $end) {
            if (-not (Test-Path "G:\")) {
              # Remount drive
              Stop-Process rclone -Force -ErrorAction SilentlyContinue
              Start-Sleep 3
              rclone mount gdrive: G: --vfs-cache-mode full --daemon
            }
            Write-Host "[$(Get-Date -f 'HH:mm')] âœ… $($env:TAILSCALE_IP):3389 | G:\ OK"
            Start-Sleep 300
          }
