name: Windows RDP + Google Drive (6 Hours)

on:
  workflow_dispatch:

jobs:
  rdp-drive:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Install WinFsp
      shell: pwsh
      run: |
        Write-Host "Installing WinFsp..."
        Invoke-WebRequest -Uri "https://github.com/winfsp/winfsp/releases/download/v2.1/winfsp-2.1.25156.msi" -OutFile "$env:TEMP\winfsp.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\winfsp.msi`" /quiet /norestart" -Wait
        Remove-Item "$env:TEMP\winfsp.msi" -Force
        Write-Host "‚úÖ WinFsp Installed"

    - name: Install rclone
      shell: pwsh
      run: |
        Write-Host "Installing rclone..."
        Invoke-WebRequest -Uri "https://downloads.rclone.org/v1.72.1/rclone-v1.72.1-windows-amd64.zip" -OutFile "$env:TEMP\rclone.zip"
        Expand-Archive "$env:TEMP\rclone.zip" -DestinationPath "$env:TEMP\rclone" -Force

        $rcloneFolder = Get-ChildItem "$env:TEMP\rclone" -Directory | Select-Object -First 1
        Copy-Item "$($rcloneFolder.FullName)\rclone.exe" "C:\Windows\System32\rclone.exe" -Force

        Remove-Item "$env:TEMP\rclone" -Recurse -Force
        Remove-Item "$env:TEMP\rclone.zip" -Force

        rclone version
        Write-Host "‚úÖ rclone Installed"

    - name: Setup Google Drive (Service Account)
      shell: pwsh
      env:
        SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
      run: |
        $configDir = "$env:USERPROFILE\.config\rclone"
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null

        # Clean JSON
        $cleanJson = $env:SA_JSON -replace '\uFEFF','' -replace '[^\x20-\x7E\n\r\t]',''
        $jsonPath = "$env:USERPROFILE\sa.json"
        [IO.File]::WriteAllText($jsonPath, $cleanJson, [Text.Encoding]::UTF8)

        try {
          $test = Get-Content $jsonPath -Raw | ConvertFrom-Json
          Write-Host "‚úÖ SA Loaded: $($test.client_email)"
        }
        catch {
          Write-Error "‚ùå Invalid JSON: $_"
          exit 1
        }

        $confPath = "$configDir\rclone.conf"

        # SAFE config writing (no YAML break)
        Set-Content -Path $confPath -Encoding ascii -Value "[gdrive]"
        Add-Content -Path $confPath -Encoding ascii -Value "type = drive"
        Add-Content -Path $confPath -Encoding ascii -Value "scope = drive"
        Add-Content -Path $confPath -Encoding ascii -Value "service_account_file = $jsonPath"

        Write-Host "‚úÖ rclone.conf created"

    - name: Test Google Drive
      shell: pwsh
      run: |
        rclone lsd gdrive:
        Write-Host "‚úÖ Drive connection OK"

    - name: Mount Google Drive as G
      shell: pwsh
      run: |
        Stop-Process -Name rclone -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2

        $configPath = "$env:USERPROFILE\.config\rclone\rclone.conf"
        $logPath = "$env:USERPROFILE\rclone_mount.log"

        $args = @(
          "mount", "gdrive:", "G:",
          "--config", $configPath,
          "--vfs-cache-mode", "full",
          "--vfs-cache-max-size", "8G",
          "--network-mode",
          "--log-file", $logPath,
          "--log-level", "INFO"
        )

        Start-Process -FilePath "rclone" -ArgumentList $args -WindowStyle Hidden

        for ($i = 0; $i -lt 40; $i++) {
          if (Test-Path "G:\") {
            Write-Host "‚úÖ G:\ mounted successfully"
            Get-ChildItem "G:\" | Select-Object -First 20 | Format-Table Name
            break
          }
          Start-Sleep -Seconds 3
        }

        if (-not (Test-Path "G:\")) {
          Write-Host "‚ö†Ô∏è G:\ mount not detected yet (still continuing)"
          if (Test-Path $logPath) {
            Write-Host "Last 60 log lines:"
            Get-Content $logPath -Tail 60
          }
        }

    - name: Enable RDP
      shell: pwsh
      run: |
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Restart-Service TermService -Force
        Write-Host "‚úÖ RDP Enabled"

    - name: Create RDP User
      shell: pwsh
      run: |
        $pass = -join ((65..90)+(97..122)+(48..57) | Get-Random -Count 16 | ForEach-Object {[char]$_})
        $securePass = ConvertTo-SecureString $pass -AsPlainText -Force

        try {
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires -PasswordNeverExpires -ErrorAction Stop
        } catch {
          Write-Host "User already exists, resetting password..."
          Set-LocalUser -Name "RDPUser" -Password $securePass
        }

        Add-LocalGroupMember -Group "Administrators" -Member "RDPUser" -ErrorAction SilentlyContinue
        echo "PASS=$pass" >> $env:GITHUB_ENV

        Write-Host "‚úÖ User created: RDPUser"

    - name: Install Tailscale
      shell: pwsh
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\ts.msi"
        Start-Process msiexec.exe -ArgumentList "/i `"$env:TEMP\ts.msi`" /quiet /norestart" -Wait
        Remove-Item "$env:TEMP\ts.msi" -Force

        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TSKEY --hostname="gh-rdp-${{ github.run_id }}" --accept-risk=all
        $ip = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip --4)[0]

        echo "IP=$ip" >> $env:GITHUB_ENV
        Write-Host "‚úÖ Tailscale IP: $ip"

    - name: INFO
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "üéâ CONNECT VIA TAILSCALE:" -ForegroundColor Green
        Write-Host "$($env:IP):3389" -ForegroundColor Green
        Write-Host "Username: RDPUser" -ForegroundColor Cyan
        Write-Host "Password: $($env:PASS)" -ForegroundColor Cyan
        Write-Host "Google Drive mounted at: G:\" -ForegroundColor Yellow
        Write-Host ""

    - name: Keep Alive (6 Hours)
      shell: pwsh
      run: |
        $minutes = 360
        $configPath = "$env:USERPROFILE\.config\rclone\rclone.conf"
        $logPath = "$env:USERPROFILE\rclone_mount.log"

        for ($m=1; $m -le $minutes; $m++) {

          if (-not (Test-Path "G:\")) {
            Write-Host "‚ö†Ô∏è Drive disappeared! Remounting..."
            Stop-Process -Name rclone -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2

            $args = @(
              "mount", "gdrive:", "G:",
              "--config", $configPath,
              "--vfs-cache-mode", "full",
              "--vfs-cache-max-size", "8G",
              "--network-mode",
              "--log-file", $logPath,
              "--log-level", "INFO"
            )

            Start-Process -FilePath "rclone" -ArgumentList $args -WindowStyle Hidden
          }

          Write-Host "$(Get-Date -Format HH:mm:ss) ‚úÖ Alive | Remaining: $($minutes-$m) min | IP: $($env:IP):3389"
          Start-Sleep -Seconds 60
        }

        Write-Host "‚úÖ Finished 6 hours. Workflow ending."
